<?xml version="1.0" encoding="UTF-8"?>
<project name="build_rules">
  <property file="${top.dir}/make/android/build.properties" />
  
  <import file="nativelibs.xml" />

  <target name="getversion">
    <sequential>
      <exec executable="make" outputproperty="version.index.base" failonerror="true">
        <arg value="--quiet"/>
        <arg value="-f"/>
        <arg value="${top.dir}/make/version.mak"/>
        <arg value="version_index"/>
      </exec>
      <!-- version.name does not work... -->
      <exec executable="make" outputproperty="version.base" failonerror="true">
        <arg value="--quiet"/>
        <arg value="-f"/>
        <arg value="${top.dir}/make/version.mak"/>
        <arg value="version_name"/>
      </exec>
      <property name="build.dir" value="${builds.dir}/${version.base}/android" />
      <echo level="info">Base version is ${version.base} (${version.index.base}). Build dir is ${build.dir}</echo>
    </sequential>
  </target>
  
  <target name="checkmanifesttype">
    <available file="AndroidManifest.data" property="xsltmanifest"/>
  </target>
  
  <target name="xsltmanifest" depends="checkmanifesttype" if="xsltmanifest">
    <exec executable="xsltproc" failonerror="true">
      <arg value="--stringparam"/>
      <arg value="version.index"/>
      <arg value="${version.index}"/>
      <arg value="--stringparam"/>
      <arg value="version"/>
      <arg value="${version}"/>
      <arg value="--output"/>
      <arg value="AndroidManifest.xml"/>
      <arg value="AndroidManifest.tmpl"/>
      <arg value="AndroidManifest.data"/>
    </exec>
  </target>
  
  <target name="substmanifest" depends="checkmanifesttype" unless="xsltmanifest">
    <copy file="AndroidManifest.tmpl" tofile="AndroidManifest.xml" overwrite="yes" >
      <filterset>
        <filter token="version" value="${version}" />
        <filter token="version.index" value="${version.index}" />
      </filterset>
    </copy>
  </target>
  
  <!-- http://stackoverflow.com/questions/16359221/how-to-add-any-number-to-a-property-from-a-property-file -->
  <macrodef name="math">
    <attribute name="operation"/>
    <attribute name="operator1"/>
    <attribute name="operator2"/>
    <attribute name="result"/>
    <sequential>
    <script language="javascript">
     tmp = 0;
     switch ("@{operation}")
     {
      case "+" :
       tmp = parseInt("@{operator1}") + parseInt("@{operator2}");
       break;
      case "-" :
       tmp = parseInt("@{operator1}") - parseInt("@{operator2}");
       break;
      case "*" :
       tmp = parseInt("@{operator1}") * parseInt("@{operator2}");
       break;
      case "/" :
       tmp = parseInt("@{operator1}") / parseInt("@{operator2}");
       break;
     }
     project.setProperty("@{result}", tmp);
    </script>
    </sequential>
  </macrodef>

  <target name="getfixedversion" depends="getversion">
    <condition property="version.suffix" value="+${version.delta}_${arch}" else="">
      <isset property="arch" />
    </condition>
    <condition property="version.delta" value="0">
      <not>
        <isset property="arch" />
      </not>
    </condition>
    <property name="version" value="${version.base}${version.suffix}" />
    <math operation="+" operator1="${version.index.base}" operator2="${version.delta}" result="version.index" />
    <echo level="info">Full version is ${version} (${version.index})</echo>
  </target>
  
  <target name="makemanifest" depends="getfixedversion,xsltmanifest,substmanifest">
  </target>
  
  <target name="makepackage" depends="makemanifest,nativelibs,release">
    <copy file="${out.final.file}" toFile="${build.dir}/${ant.project.name}_${version}.apk" overwrite="true" />
  </target>
  
  <target name="public-build-some">
    <delete dir="${native.libs.absolute.dir}" />
    <delete file="${build.result}" />
    <antcall target="makepackage" />
  </target>
  
  <target name="public-build-fat">
    <antcall target="public-build-some" />
  </target>
  
  <target name="public-build-thin">
    <for-arch target="public-build-some" />
  </target>

  <!-- Full public build target (fat+thin) -->
  <target name="public-build" depends="public-build-fat,public-build-thin,debugarchive">
  </target>
</project>
