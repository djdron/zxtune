<?xml version="1.0" encoding="UTF-8"?>
<project name="nativelibs">
  <!-- for and foreach only in ant-contrib, so they are not used -->

  <!-- default properties -->
  <property name="cpu.cores" value="1" />
  <property name="native.libs.source.dir" value="jni" />
  <property name="native.libs.absolute.dir" location="${pkg.dir}/libs" />

  <macrodef name="buildlib-helper">
    <attribute name="arch" />
    <sequential>
      <exec executable="make" failonerror="true">
        <arg value="platform=android" />
        <arg value="arch=@{arch}" />
        <arg value="-C" />
        <arg value="${native.libs.source.dir}" />
        <arg value="-j" />
        <arg value="${cpu.cores}" />
      </exec>
    </sequential>
  </macrodef>

  <macrodef name="installib-helper">
    <attribute name="arch" />
    <sequential>
      <mkdir dir="${native.libs.absolute.dir}/@{arch}" />
      <exec executable="make" failonerror="true">
        <arg value="DESTDIR=${native.libs.absolute.dir}/@{arch}" />
        <arg value="platform=android" />
        <arg value="arch=@{arch}" />
        <arg value="-C" />
        <arg value="${native.libs.source.dir}" />
        <arg value="install" />
      </exec>
    </sequential>
  </macrodef>

  <macrodef name="makelib-helper">
    <attribute name="arch" />
    <sequential>
      <echo level="info">Make native library for arch @{arch}</echo>
      <buildlib-helper arch="@{arch}" />
      <installib-helper arch="@{arch}" />
    </sequential>
  </macrodef>

  <macrodef name="for-arch">
    <attribute name="target" />
    <sequential>
      <!-- http://brian.io/android-ndk-r10c-docs/Programmers_Guide/html/md_3__key__topics__c_p_u__support__chapter_1-section_8__a_b_is.html -->
      <antcall target="@{target}">
        <param name="arch" value="x86" />
        <param name="version.delta" value="1" />
      </antcall>
      <!--
      <antcall target="@{target}">
        <param name="arch" value="x86-64" />
        <param name="version.delta" value="2" />
      </antcall>
      <antcall target="@{target}">
        <param name="arch" value="mips" />
        <param name="version.delta" value="3" />
      </antcall>
      <antcall target="@{target}">
        <param name="arch" value="mips64" />
        <param name="version.delta" value="4" />
      </antcall>
      -->
      <antcall target="@{target}">
        <param name="arch" value="armeabi" />
        <param name="version.delta" value="5" />
      </antcall>
      <antcall target="@{target}">
        <param name="arch" value="armeabi-v7a"/>
        <param name="version.delta" value="6" />
      </antcall>
      <!--
      <antcall target="@{target}">
        <param name="arch" value="arm64-8a" />
        <param name="version.delta" value="7" />
        <param name="version.suffix" value="_arm64-8a" />
      </antcall>
      -->
    </sequential>
  </macrodef>
  
  <target name="nativelibs-arch" if="arch">
    <makelib-helper arch="${arch}"/>
  </target>

  <target name="nativelibs-all" unless="arch">
    <for-arch target="nativelibs-arch" />
  </target>
  
  <target name="nativelibs" depends="nativelibs-all,nativelibs-arch">
  </target>

  <target name="nativelib-debug">
    <mkdir dir="${debug.dir}/${arch}" />
    <exec executable="make" failonerror="true">
      <arg value="DESTDIR=${debug.dir}/${arch}" />
      <arg value="platform=android" />
      <arg value="arch=${arch}" />
      <arg value="-C" />
      <arg value="${native.libs.source.dir}" />
      <arg value="install_debug" />
    </exec>
  </target>
  
  <target name="debugarchive" depends="getversion">
    <property name="debug.dir" location="${build.dir}/debug" />
    <property name="arch=" value="" />
    <for-arch target="nativelib-debug" />
    <exec executable="tar" failonerror="true">
      <arg value="-cjf" />
      <arg value="${build.dir}/${ant.project.name}.tar.bz2" />
      <arg value="--remove-files" />
      <arg value="${debug.dir}" />
    </exec>
  </target>
</project>
